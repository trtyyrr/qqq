name: Build OnePlus Pad Pro (Ultimate AI Kernel)
on:
  workflow_dispatch:  # 手动触发按钮

jobs:
  build:
    name: Compile with SukiSU & AI Features
    runs-on: ubuntu-22.04
    
    steps:
    - name: 1. 环境准备 (清理 30GB+)
      uses: jlumbroso/free-disk-space@main
      with:
        tool-cache: true
        android: true
        dotnet: true
        haskell: true
        large-packages: true
        swap-storage: true

    - name: 2. 安装编译依赖
      run: |
        sudo apt-get update
        sudo apt-get install -y git ccache automake flex lzop bison gperf build-essential zip curl zlib1g-dev g++-multilib libxml2-utils bzip2 libbz2-dev libbz2-1.0 libghc-bzlib-dev squashfs-tools pngcrush schedtool dpkg-dev liblz4-tool make optipng maven libssl-dev bc rsync
        
        # 安装 Repo 工具
        mkdir -p ~/bin
        curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
        chmod a+x ~/bin/repo
        echo "$HOME/bin" >> $GITHUB_PATH
        
        # 配置 Git 身份
        git config --global user.name "GitHub Action"git config --global user.email "action@github.com"

    -  name: 3. 同步源码 (修正版)
      run: |
        mkdir -p kernel_workspace
        cd kernel_workspace
        
        # --- 修复核心：建立本地 Manifest 仓库 ---
        mkdir -p local_manifest
        cd local_manifest
        
        # 1. 初始化 Git
        git init
        git branch -m main
        git config user.name "GitHub Action"git config user.email "action@github.com"
        
        # 2. 写入配置
        cat <<EOF > default.xml
        <?xml version="1.0" encoding="UTF-8"?>
        <manifest>
          <remote fetch="https://git.codelinaro.org/clo/la" name="clo-la"/>
          <remote fetch="https://github.com/OnePlusOSS" name="origin"/>
          <default remote="clo-la" revision="dummy_revision" sync-c="true" sync-tags="false"/>
          <project remote="origin" name="android_kernel_common_oneplus_sm8650" path="kernel_platform/common" revision="oneplus/sm8650_u_14.1.0_onepluspad_pro"><linkfile dest="kernel_platform/.source_date_epoch_dir" src="."/></project>
          <project remote="origin" name="android_kernel_oneplus_sm8650" path="kernel_platform/msm-kernel" revision="oneplus/sm8650_u_14.1.0_onepluspad_pro"><linkfile dest="kernel_platform/WORKSPACE" src="bazel.WORKSPACE"/><linkfile dest="kernel_platform/build_with_bazel.py" src="build_with_bazel.py"/></project>
          <project remote="origin" name="android_kernel_modules_and_devicetree_oneplus_sm8650" path="./" revision="oneplus/sm8650_u_14.1.0_onepluspad_pro"/>
          <project remote="clo-la" name="kernel/prebuilts/build-tools" path="kernel_platform/prebuilts/kernel-build-tools" revision="d153b7ab4a4956198957e258d4f370e875c53059" upstream="refs/heads/ks-kernel.lnx.3.0.r1-rel"><linkfile dest="kernel_platform/build/prebuilts/kernel-build-tools" src="."/></project>
          <project remote="clo-la" name="kernel_platform/build/bazel_common_rules" path="kernel_platform/build/bazel_common_rules" revision="415b543d5e1d270a22f8c6ae9d848b3560472062" upstream="refs/heads/ks-kernel.lnx.3.0.r1-rel"/>
          <project remote="clo-la" name="kernel_platform/external/bazel-skylib" path="kernel_platform/external/bazel-skylib" revision="7fdbc462f5001b7e82f026aa90bd43c494e2a8d8" upstream="refs/heads/ks-kernel.lnx.3.0.r1-rel"/>
          <project remote="clo-la" name="kernel_platform/external/dtc" path="kernel_platform/external/dtc" revision="3a8c1bbce993f9143835c7f40eeefcdf948cfaf5" upstream="refs/heads/kernel.build.lnx.1.0.r15-rel"/>
          <project remote="clo-la" name="kernel_platform/external/python/absl-py" path="kernel_platform/external/python/absl-py" revision="e46584edbb247bf79c74c4f105b6fff18234cee8" upstream="refs/heads/ks-kernel.lnx.3.0.r1-rel"/>
          <project remote="clo-la" name="kernel_platform/external/stardoc" path="kernel_platform/external/stardoc" revision="0d74fed6f8d0844f696771e71bc0b071cae99021" upstream="refs/heads/ks-kernel.lnx.3.0.r1-rel"/>
          <project remote="clo-la" name="kernel_platform/prebuilts/bazel/linux-x86_64" path="kernel_platform/prebuilts/bazel/linux-x86_64" revision="eee09422f02e60f28192bcb5a8ce8660baba6706" upstream="refs/heads/ks-kernel.lnx.3.0.r1-rel"/>
          <project remote="clo-la" name="kernel_platform/prebuilts/build-tools" path="kernel_platform/prebuilts/build-tools" revision="cad7e11de82b3307000e09c9d539b2700bd17aea" upstream="refs/heads/ks-kernel.lnx.3.0.r1-rel"><linkfile dest="kernel_platform/build/prebuilts/build-tools" src="."/></project>
          <project remote="clo-la" name="kernel_platform/prebuilts/clang-tools" path="kernel_platform/prebuilts/clang-tools" revision="0613fc5443d035335a9541994607bacae03750f2" upstream="refs/heads/ks-kernel.lnx.3.0.r1-rel"><linkfile dest="kernel_platform/build/prebuilts/clang-tools" src="."/></project>
          <project remote="clo-la" name="kernel_platform/prebuilts/jdk/jdk11" path="kernel_platform/prebuilts/jdk/jdk11" revision="ced68c9308cbc1b6ec3e602dba8d0d56df8b6d73" upstream="refs/heads/ks-kernel.lnx.3.0.r1-rel"/>
          <project remote="clo-la" name="kernel_platform/system/tools/mkbootimg" path="kernel_platform/tools/mkbootimg" revision="b17f184a20744a7e0a421f901bdf20a23be22b07" upstream="refs/heads/ks-kernel.lnx.3.0.r1-rel"/>
          <project remote="clo-la" name="kernel_platform/toolchain/prebuilts/ndk/r23" path="kernel_platform/prebuilts/ndk-r23" revision="269a5dc9e862f78dc2030d9262f73cb2642b8127" upstream="refs/heads/ks-kernel.lnx.3.0.r1-rel"/>
          <project remote="clo-la" name="kernelplatform/prebuilts-master/clang/host/linux-x86" path="kernel_platform/prebuilts/clang/host/linux-x86" revision="28b975ada54f8610ed531a6b57253aed10e7c87d" upstream="refs/heads/ks-kernel.lnx.3.0.r1-rel"/>
          <project remote="clo-la" name="kernelplatform/prebuilts/gcc/linux-x86/host/x86_64-linux-glibc2.17-4.8" path="kernel_platform/prebuilts/gcc/linux-x86/host/x86_64-linux-glibc2.17-4.8" revision="dd099b5d68822602228e2af66693e61e7b54e0a9" upstream="refs/heads/ks-kernel.lnx.3.0.r1-rel"><linkfile dest="kernel_platform/build/build-tools/sysroot" src="sysroot"/></project>
        </manifest>
        EOF
        # 3. 提交到本地 Git
        git add default.xml
        git commit -m "Init manifest"
        
        # 4. 获取当前绝对路径 (Repo 需要)
        MANIFEST_PATH=$(pwd)
        cd ..
        
        # --- 初始化 Repo ---
        # 现在 -u 指向的是一个真正的 Git 仓库目录，不会再报错了
        repo init -u "$MANIFEST_PATH" -m default.xml --depth=1
        repo sync -c -j$(nproc) --no-tags --no-clone-bundle --prune

            - name: 4. 功能注入 (SukiSU + SUSFS + BBG)
              run: |
        cd kernel_workspace/kernel_platform/common
        
        # --- SUSFS 内联挂钩 ---
        echo ">>> 下载 SUSFS..."
        git clone https://gitlab.com/simonpunk/susfs4ksu.git susfs_temp
        cp susfs_temp/kernel_patches/include/linux/susfs.h include/linux/
        
        echo ">>> 应用 Inline Hook..."
        PATCH_FILE="susfs_temp/kernel_patches/50_add_susfs_in_gki-android14-6.1.patch"
        if git apply "$PATCH_FILE"; then
            echo "✅ SUSFS Patch Applied"
        else
            echo "⚠️ 标准Patch失败，尝试宽松模式..."
            git apply --ignore-whitespace --ignore-space-change "$PATCH_FILE" || git apply --reject "$PATCH_FILE" || true
        fi

        # --- SukiSU (RSuntK) ---
        echo ">>> 集成 SukiSU..."
        git clone https://github.com/RSuntK/KernelSU.git drivers/su
        if ! grep -q "drivers/su" drivers/Makefile; then echo "obj-y += su/" >> drivers/Makefile; fi

        # --- BBG (Baseband Guard) ---
        echo ">>> 集成 BBG..."
        git clone https://github.com/vc-teahouse/Baseband-guard.git security/bbguard
        if ! grep -q "bbguard" security/Makefile; then
            echo "obj-\$(CONFIG_BBGUARD) += bbguard/" >> security/Makefile
            echo "source \"security/bbguard/Kconfig\"" >> security/Kconfig
        fi

    - name: 5. 终极内核配置 (BBR + ZRAM + AI)
      run: |
        cd kernel_workspace/kernel_platform/common
        
        echo ">>> 正在启用全套黑科技配置..."
        ./scripts/config --file arch/arm64/configs/gki_defconfig \
            --enable CONFIG_KSU \
            --enable CONFIG_SUSFS \
            --enable CONFIG_KSU_SUSFS \
            --enable CONFIG_KSU_SUSFS_SUS_PATH \
            --enable CONFIG_KSU_SUSFS_SUS_MOUNT \
            --enable CONFIG_BBGUARD \
            --enable CONFIG_TCP_CONG_BBR \
            --set-str CONFIG_DEFAULT_TCP_CONG "bbr" \
            \
            --enable CONFIG_ZRAM \
            --enable CONFIG_ZRAM_WRITEBACK \
            --enable CONFIG_ZRAM_MEMORY_TRACKING \
            --enable CONFIG_CRYPTO_ZSTD \
            --enable CONFIG_ZRAM_DEF_COMP_ZSTD \
            \
            --enable CONFIG_LRU_GEN \
            --enable CONFIG_LRU_GEN_ENABLED \
            --enable CONFIG_LRU_GEN_STATS \
            \
            --enable CONFIG_UCLAMP_TASK \
            --enable CONFIG_UCLAMP_TASK_GROUP \
            --enable CONFIG_ENERGY_MODEL \
            --enable CONFIG_SCHED_WALT \
            \
            --enable CONFIG_WQ_POWER_EFFICIENT_DEFAULT \
            --enable CONFIG_RCU_BOOST \
            \
            --disable CONFIG_TCP_CONG_CUBIC \
            --disable CONFIG_MODULE_SIG_ALL \
            --disable CONFIG_DEBUG_KERNEL \
            --disable CONFIG_DEBUG_INFO

    - name: 6. 编译内核 (Bazel / SM8650)
      run: |
        cd kernel_workspace/kernel_platform
        LTO=thin ./build_with_bazel.py -t pineapple gki --config=stamp

    - name: 7. 打包与上传
      run: |
        cd kernel_workspace
        git clone https://github.com/osm0sis/AnyKernel3
        cd AnyKernel3
        
        # 提取 Image 和 dtbo
        cp ../kernel_platform/out/pineapple/dist/Image .
        [ -f ../kernel_platform/out/pineapple/dist/dtbo.img ] && cp ../kernel_platform/out/pineapple/dist/dtbo.img .

        # 生成最终 ZIP
        zip -r9 OnePlusPadPro_Ultimate_Kernel.zip * -x .git README.md *placeholder
        
    - uses: actions/upload-artifact@v4
      with:
        name: OnePlusPadPro_Ultimate_Kernel
        path: kernel_workspace/AnyKernel3/OnePlusPadPro_Ultimate_Kernel.zip
